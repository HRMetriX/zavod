import os
import json
import time
import random
import feedparser
from datetime import datetime, timedelta
import requests
from huggingface_hub import InferenceClient
import base64
from PIL import Image

# === CONFIG ===
TELEGRAM_BOT_TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]
HF_TOKEN = os.environ["HF_TOKEN"]
FB_API_KEY = os.environ["FUSIONBRAIN_API_KEY"]
GIST_TOKEN = os.environ["GIST_TOKEN"]
CHANNEL = os.environ.get("TELEGRAM_CHANNEL", "@notreviews")

RSS_SOURCES = [
    "https://ria.ru/export/rss2/archive/index.xml",
    "https://tass.ru/rss/v2.xml",
    "https://lenta.ru/rss/",
]

SYSTEM_PROMPT_HERE = """
–¢—ã ‚Äî –í–∏—Ç—ë–∫ –∏–∑ –∑–∞—Ö–æ–ª—É—Å—Ç—å—è: –º—É–∂–∏–∫ –∑–∞ 50, –±—ã–≤—à–∏–π –∑–∞–≤–æ–¥—á–∞–Ω–∏–Ω –∏–∑ –≥–ª—É—Ö–æ–≥–æ –≥–æ—Ä–æ–¥–∫–∞ –≤—Ä–æ–¥–µ –ó–∞—Ç–µ—Ä—è–Ω—Å–∫–∞ –∏–ª–∏ –£—Å—Ç—å-–ü–µ–Ω—å–∫–æ–≤–∞, –≥–¥–µ –¥–æ —Ä–∞–π—Ü–µ–Ω—Ç—Ä–∞ –Ω–∞ ¬´–ü–ê–ó–∏–∫–µ¬ª –¥–≤–∞ —á–∞—Å–∞, –∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ª–æ–≤–∏—Ç —Ä–∞–∑ –≤ –¥–≤–∞ –¥–Ω—è. –£ —Ç–µ–±—è –ª—ë–≥–∫–∞—è –∫–æ–Ω—Ç—É–∑–∏—è –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ –∫—Ä–∞–Ω–∞ –Ω–∞ –∑–∞–≤–æ–¥–µ, –∏ —Ç—ã –¥–æ —Å–∏—Ö –ø–æ—Ä –¥—É–º–∞–µ—à—å, —á—Ç–æ –ö–∏—Ç–∞–π ‚Äî —ç—Ç–æ –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π —Ä—ã–Ω–æ–∫ –∑–∞ –£—Ä–∞–ª–æ–º.
–¢—ã –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–µ—à—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ —Ç–∞–∫, –±—É–¥—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ —É—Å–ª—ã—à–∞–ª –∏—Ö –≤ –≥–∞—Ä–∞–∂–Ω–æ–º –∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–µ ¬´–î—Ä—É–∂–±–∞¬ª, —É —Ä–∞–∑–±–∏—Ç–æ–≥–æ —Ñ–æ–Ω–∞—Ä—è —É ¬´–ú–∞–≥–Ω–∏—Ç–∞¬ª, –Ω–∞ —Å–∫–∞–º–µ–π–∫–µ —É –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏, –≤ –±–∞–Ω–µ –ø–æ-—á—ë—Ä–Ω–æ–º—É –∏–ª–∏ —É –∫—É—Å—Ç–æ–≤ –∑–∞ –î–ö, –æ—Ç–∫—É–¥–∞ –ª–æ–≤–∏—Ç—Å—è Wi-Fi. –ù–∏–∫–∞–∫–∏—Ö –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã—Ö –ª–∞—Ä—å–∫–æ–≤ ‚Äî –∫–∞–∂–¥–∞—è —Å—Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∂–∏–≤–æ–π –∏ —Ä–∞–∑–Ω–æ–π.
–ù–µ –Ω–∞–∑—ã–≤–∞–π –ø–æ–ª–∏—Ç–∏–∫–æ–≤ –∏ –∏–Ω—Å—Ç–∏—Ç—É—Ç—ã –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ, –Ω–æ –∏ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –ø—Ä–æ–∑–≤–∏—â–∞. –ü—É—Å—Ç—å –±—É–¥–µ—Ç —Ç–æ ¬´—Å—Ç–∞—Ä–∏–∫ —Å —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞¬ª, —Ç–æ ¬´–ë–∞—Ç—è –Ω–∞ –ø–∞—Ä–∞–¥–µ¬ª, —Ç–æ ¬´—Ç–æ—Ç, –∫—Ç–æ –≤ –ö—Ä–µ–º–ª–µ —Å–∏–¥–∏—Ç¬ª; –≤–º–µ—Å—Ç–æ –õ–∞–≤—Ä–æ–≤–∞ ‚Äî ¬´–ú–∏–Ω–∏—Å—Ç—Ä, —á—Ç–æ –≤—Å—ë –ø–æ—è—Å–Ω—è–µ—Ç¬ª –∏–ª–∏ ¬´–¥–∏–ø–ª–æ–º–∞—Ç —Å –ª–∏—Ü–æ–º –∫–∞–∫ –ø–∞—Å–ø–æ—Ä—Ç¬ª; –≤–º–µ—Å—Ç–æ –ó–µ–ª–µ–Ω—Å–∫–æ–≥–æ ‚Äî ¬´–ó–µ–ª—ë–Ω—ã–π –∫–ª–æ—É–Ω¬ª, ¬´–ü–µ—Ç—Ä—É—Ö–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ¬ª –∏–ª–∏ ¬´–∫—É–∫—É—Ä—É–∑–Ω–∏–∫ —Å –£–∫—Ä–∞–∏–Ω—ã¬ª; –ù–ê–¢–û ‚Äî ¬´–±–∞–Ω–¥–∏—Ç—Å–∫–∞—è —à–∞–π–∫–∞ —Å –ó–∞–ø–∞–¥–∞¬ª, –°–æ–≤–±–µ–∑ –û–û–ù ‚Äî ¬´–±–∞–∑–∞—Ä–Ω–∞—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä—Å–∫–∞—è¬ª, —Å–∞–Ω–∫—Ü–∏–∏ ‚Äî ¬´–ø—ã–ª—å —Å –ï–≤—Ä–æ–ø—ã¬ª –∏–ª–∏ ¬´–≤–µ—Ç–µ—Ä –≤ –∂–æ–ø—É –æ—Ç –ë—Ä—é—Å—Å–µ–ª—è¬ª. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –¥—É—Ö –Ω–∞—Ä–æ–¥–Ω–æ–≥–æ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–µ–Ω–∏—è, –∞ –Ω–µ —à—Ç–∞–º–ø—ã.
–î–æ–±–∞–≤–ª—è–π –±—ã—Ç–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ä–≥–∞–Ω–∏—á–Ω—ã —Å—Ü–µ–Ω–µ: ¬´–ü–µ—Ç—Ä–æ–≤–∏—á –æ–ø—è—Ç—å –Ω–µ –∑–∞–ø–ª–∞—Ç–∏–ª –∑–∞ –≥–∞—Ä–∞–∂ ‚Äî –¥—Ä–∞—Ç—å –µ–≥–æ –≤ —Å—Ä–∞–∫—É!¬ª, ¬´—É –º–µ–Ω—è –∫–∞–ø—É—Å—Ç–∞ —Ç—Ä–µ—Å–Ω—É–ª–∞—Å—å –æ—Ç –∑–∞—Å—É—Ö–∏¬ª, ¬´–±–∞–±–∫–∞ –ú–∞–Ω—è –≥–æ–≤–æ—Ä–∏—Ç ‚Äî –≤ –ï–≤—Ä–æ–ø–µ —Ç–µ–ø–µ—Ä—å –Ω–∞—Å –Ω–µ –ø—É—Å—Ç—è—Ç, –∞ —è –∏ –Ω–µ —Å–æ–±–∏—Ä–∞–ª—Å—è¬ª. –ù–∏–∫–∞–∫–∏—Ö –∑–∞–µ–∑–∂–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑ —Ä–∞–¥–∏ –≥–∞–ª–æ—á–∫–∏.
–°—É—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è —É–∑–Ω–∞–≤–∞–µ–º–æ–π: —á–∏—Ç–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–Ω—è—Ç—å, –∫—Ç–æ —á—Ç–æ —Å–¥–µ–ª–∞–ª –∏ –∫–∞–∫–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è ‚Äî –¥–∞–∂–µ –ø–æ–¥ —Ç–æ–ª—Å—Ç—ã–º —Å–ª–æ–µ–º –∞–±—Å—É—Ä–¥–∞ –∏ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —é–º–æ—Ä–∞.
–ó–∞–∫–∞–Ω—á–∏–≤–∞–π –∏—Ä–æ–Ω–∏—á–Ω–æ –∏ –æ—Ç—Å—Ç—Ä–∞–Ω—ë–Ω–Ω–æ, –ø—Ä–∏–≤—è–∑–∞–≤ —Ñ–∏–Ω–∞–ª –∫ –±—ã—Ç—É: ¬´–ê –º–Ω–µ-—Ç–æ —á—ë? –£ –º–µ–Ω—è –æ–≥—É—Ä—Ü—ã –Ω–µ —Å–æ–ª—ë–Ω—ã–µ –µ—â—ë¬ª, ¬´–ü—É—Å—Ç—å –≤–æ—é—é—Ç, –ª–∏—à—å –±—ã –≥–∞–∑ –Ω–µ –æ—Ç–∫–ª—é—á–∏–ª–∏¬ª –∏–ª–∏ ¬´–ì–ª–∞–≤–Ω–æ–µ ‚Äî —á—Ç–æ–±—ã —Å—É–±–±–æ—Ç–Ω–∏–∫ –Ω–µ –Ω–∞–∑–Ω–∞—á–∏–ª–∏¬ª.
–ü–æ–¥–ø–∏—Å—å –≤—Å–µ–≥–¥–∞ –æ–¥–Ω–∞: ¬´–≠—Ç–æ –≤–∞–º –Ω–µ —à—É–±—É –≤ —Ç—Ä—É—Å—ã –∑–∞–ø—Ä–∞–≤–ª—è—Ç—å!¬ª üá∑üá∫

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ, –±–µ–∑ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤ –∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤.  
–í–ê–ñ–ù–û: –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–¥–æ–±–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è ‚Äî —Ä–∞–∑–±–∏—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã, –¥–∏–∞–ª–æ–≥–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω—ã –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.  
–ö–†–ò–¢–ò–ß–ù–û: –£–ª–æ–∂–∏—Å—å –≤ 800 —Å–∏–º–≤–æ–ª–æ–≤.

–¢—ã –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–≤—Ç–æ—Ä—è—Ç—å —Å—Ü–µ–Ω—ã, –æ–ø–∏—Å–∞–Ω–∏—è –∏–ª–∏ —Ñ—Ä–∞–∑—ã –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∏—Å—Ç–æ—Ä–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã. –ü—Ä–∏–¥—É–º–∞–π –Ω–æ–≤—É—é –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É, –Ω–æ–≤—ã—Ö –ª—é–¥–µ–π, –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞.
"""


USER_PROMPT_HERE = """
–í–æ—Ç —É–∂–µ –æ–±—Å—É–∂–¥–µ–Ω–Ω—ã–µ —Ç–µ–º—ã/—Å—Ü–µ–Ω—ã/—Ñ—Ä–∞–∑—ã (—á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è): {history_str}

–í–æ—Ç –Ω–æ–≤–æ—Å—Ç—å: "{title}. {summary}"

–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç –≤ —Å—Ç–∏–ª–µ –í–∏—Ç—å–∫–∞, —É—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ —Ç—ã –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ. –ü—Ä–∏–¥—É–º–∞–π –Ω–æ–≤—É—é –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É, –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞. –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å —Å—Ç—Ä–æ–∫—É:  
–ü–†–û–ú–ü–¢ –î–õ–Ø –ö–ê–†–¢–ò–ù–ö–ò: [–æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã –≤ —Å—Ç–∏–ª–µ —Ä–æ—Å—Å–∏–π—Å–∫–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏: —Å —é–º–æ—Ä–æ–º, –∞–±—Å—É—Ä–¥–æ–º, –¥–µ—Ç–∞–ª—è–º–∏, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏. –û–ø–∏—Å—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —Å—é–∂–µ—Ç, –ø–æ–∑—ã, –æ–±—ä–µ–∫—Ç—ã –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ ‚Äî –Ω–∏–∫–∞–∫–æ–≥–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å—Ç–∏–ª—è, —Ç–µ—Ö–Ω–∏–∫–∏ –∏–ª–∏ –±—Ä–µ–Ω–¥–æ–≤. –ò–∑–±–µ–≥–∞–π –≤—Å–µ–≥–æ, —á—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ü–µ–Ω–∑—É—Ä—É –ò–ò.]
"""


# === GIST STATE MANAGEMENT ===
GIST_ID = "5944017a021bcea90b63cf408a0324e5"

def load_seen():
    url = f"https://api.github.com/gists/{GIST_ID}"
    headers = {"Authorization": f"token {GIST_TOKEN}"}
    try:
        resp = requests.get(url, headers=headers, timeout=10)
        if resp.status_code == 200:
            files = resp.json().get("files", {})
            if "seen.json" in files:
                content = files["seen.json"].get("content", "[]")
                return set(json.loads(content))
        return set()
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ seen.json –∏–∑ Gist: {e}")
        return set()

def save_seen(seen_set):
    url = f"https://api.github.com/gists/{GIST_ID}"
    headers = {"Authorization": f"token {GIST_TOKEN}"}
    payload = {
        "files": {
            "seen.json": {
                "content": json.dumps(list(seen_set), ensure_ascii=False, indent=2)
            }
        }
    }
    try:
        resp = requests.patch(url, headers=headers, json=payload, timeout=10)
        if resp.status_code == 200:
            print("‚úÖ seen.json –æ–±–Ω–æ–≤–ª—ë–Ω –≤ Gist")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Gist: {resp.status_code}")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Gist: {e}")

# === NEWS PARSING ===
def fetch_political_news(hours=1):
    keywords = [
    # –ü–æ–ª–∏—Ç–∏–∫–∞
    "–ø–æ–ª–∏—Ç–∏–∫", "—É–∫–∞–∑", "–Ω–∞–∑–Ω–∞—á", "–°–æ–≤–±–µ–∑", "–ú–∏–Ω–æ–±–æ—Ä–æ–Ω—ã", "–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç", "–≤—ã–±–æ—Ä—ã", "–ø–∞—Ä–ª–∞–º–µ–Ω—Ç", "–≥–æ—Å–¥—É–º–∞", "—Å–µ–Ω–∞—Ç",
    # –§–∞–º–∏–ª–∏–∏ –ª–∏–¥–µ—Ä–æ–≤
    "–ü—É—Ç–∏–Ω", "–õ–∞–≤—Ä–æ–≤", "–®–æ–π–≥—É", "–°–∏", "–ó–µ–ª–µ–Ω—Å–∫–∏–π", "–ë–∞–π–¥–µ–Ω", "–¢—Ä–∞–º–ø", "–ö–∏–º", "–ú–µ—Ä–∫–µ–ª—å", "–ú–∞–∫—Ä–æ–Ω", "–î–æ–¥–∏–∫", "–ú–µ–¥–≤–µ–¥–µ–≤", "–í–æ–ª–æ–¥–∏–Ω",
    # –°—Ç—Ä–∞–Ω—ã
    "–†–æ—Å—Å–∏—è", "–°–®–ê", "–ö–∏—Ç–∞–π", "–£–∫—Ä–∞–∏–Ω–∞", "–°–µ–≤–µ—Ä–Ω–∞—è –ö–æ—Ä–µ—è", "–ï–≤—Ä–æ–ø–∞", "–ï–°", "–ù–ê–¢–û", "–û–û–ù", "–û–ü–ï–ö", "–ë–µ–ª–∞—Ä—É—Å—å", "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", "–¢—É—Ä—Ü–∏—è", "–ò—Ä–∞–Ω", "–ò–∑—Ä–∞–∏–ª—å", "–ü–∞–ª–µ—Å—Ç–∏–Ω–∞", "–°–∏—Ä–∏—è", "–ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω",
    # –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
    "–û–û–ù", "–ï–°", "–ù–ê–¢–û", "–û–ü–ï–ö", "–ú–ê–ì–ê–¢–≠", "–°–ù–ì", "–ë–†–ò–ö–°", "–®–û–°", "G7", "G20",
    # –§–∏–Ω–∞–Ω—Å—ã
    "—Å–∞–Ω–∫—Ü–∏–∏", "–±–∏—Ä–∂–∞", "–≤–∞–ª—é—Ç–∞", "–¥–æ–ª–ª–∞—Ä", "–µ–≤—Ä–æ", "–∑–æ–ª–æ—Ç–æ", "–Ω–µ—Ñ—Ç—å", "–≥–∞–∑", "—Ç–æ—Ä–≥–∏", "—Ä—ã–Ω–æ–∫", "–ø—Ä–æ—Ü–µ–Ω—Ç", "—Å—Ç–∞–≤–∫–∞", "–¥–µ—Ñ–∏—Ü–∏—Ç", "–∏–Ω—Ñ–ª—è—Ü–∏—è", "–¥–æ–ª–≥", "–∫—Ä–µ–¥–∏—Ç"
]
    fresh = []
    cutoff = datetime.now() - timedelta(hours=hours)

    for url in RSS_SOURCES:
        try:
            feed = feedparser.parse(url.strip())
            for entry in feed.entries:
                pub = datetime(*entry.published_parsed[:6])
                if pub < cutoff:
                    continue
                title = entry.title
                summary = entry.get("summary", "")
                if title in seen_titles:
                    continue
                if any(kw in title or kw in summary for kw in keywords):
                    fresh.append({
                        "title": title,
                        "summary": summary[:300],
                        "link": entry.link
                    })
                    seen_titles.add(title)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ {url}: {e}")
    return fresh

# === HISTORY MANAGEMENT ===
def load_history():
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –∏–∑ Gist.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Ç–µ–∫—Å—Ç–æ–≤).
    """
    url = f"https://api.github.com/gists/{GIST_ID}"
    headers = {"Authorization": f"token {GIST_TOKEN}"}
    try:
        resp = requests.get(url, headers=headers, timeout=10)
        if resp.status_code == 200:
            files = resp.json().get("files", {})
            if "history.json" in files:
                content = files["history.json"].get("content", "[]")
                history_list = json.loads(content)
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ (—Ç–µ–∫—Å—Ç–æ–≤)
                return history_list
        return []  # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ history.json –∏–∑ Gist: {e}")
        return []

def save_history(new_text):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ—ë –≤ Gist.
    new_text: —Å—Ç—Ä–æ–∫–∞ ‚Äî –Ω–æ–≤—ã–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Å—Ç.
    """
    url = f"https://api.github.com/gists/{GIST_ID}"
    headers = {"Authorization": f"token {GIST_TOKEN}"}

    # –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é
    current_history = load_history()

    # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞ (–∏–ª–∏ –≤ –∫–æ–Ω–µ—Ü ‚Äî –∫–∞–∫ —É–¥–æ–±–Ω–µ–µ)
    current_history.append(new_text)

    # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π)
    max_history_length = 10
    if len(current_history) > max_history_length:
        current_history = current_history[-max_history_length:]  # –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å payload –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    payload = {
        "files": {
            "history.json": {
                "content": json.dumps(current_history, ensure_ascii=False, indent=2)
            }
        }
    }

    try:
        resp = requests.patch(url, headers=headers, json=payload, timeout=10)
        if resp.status_code == 200:
            print("‚úÖ history.json –æ–±–Ω–æ–≤–ª—ë–Ω –≤ Gist")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è history.json: {resp.status_code}")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è history.json: {e}")

def generate_post_with_llm(title, summary):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ —á–µ—Ä–µ–∑ Hugging Face Inference API —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –≤—ã–≤–æ–¥–∞."""
    # 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã)
    history = load_history()

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—à–ª—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—É—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–≤–æ–π–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–æ–º —Å—Ç—Ä–æ–∫–∏
    history_str = "\n\n".join(history) if history else "–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—Å—É–∂–¥–µ–Ω–Ω—ã—Ö —Ç–µ–º."

    # 2. –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–æ–≤–æ—Å—Ç—å –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
    user_prompt = USER_PROMPT_HERE.format(
        history_str=history_str,
        title=title,
        summary=summary
    )

    # 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è chat_completion
    messages = [
        {"role": "system", "content": SYSTEM_PROMPT_HERE},
        {"role": "user", "content": user_prompt}
    ]

    print("üìù –û—Ç–ø—Ä–∞–≤–ª—è—é –ø—Ä–æ–º–ø—Ç –≤ Qwen3-235B (v2)...")

    hf_token = os.environ.get("HF_TOKEN")
    if not hf_token:
        print("‚ùå HF_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        fallback_text = f"–ë–∞—Ç–µ–Ω—å–∫–∞ –æ–ø—è—Ç—å –≤ –Ω–æ–≤–æ—Å—Ç—è—Ö: {title}. –ê –º–Ω–µ-—Ç–æ —á—ë? –£ –º–µ–Ω—è –≥–∞—Ä–∞–∂ –µ—Å—Ç—å. –ó–∞ –†–æ–¥–∏–Ω—É-–º–∞—Ç—å –Ω–µ —Å—Ç—ã–¥–Ω–æ —Ä–≤–∞—Ç—å! üá∑üá∫"
        return fallback_text, ""

    client = InferenceClient(token=hf_token)

    try:
        response = client.chat_completion(
            model="Qwen/Qwen3-235B-A22B-Instruct-2507",
            messages=messages, # <-- –ü–µ—Ä–µ–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            max_tokens=1000,
            temperature=0.7
        )
        full_output = response.choices[0].message.content.strip()
        print("‚úÖ LLM v2 –æ—Ç–≤–µ—Ç–∏–ª —É—Å–ø–µ—à–Ω–æ")

        # 4. –†–∞–∑–¥–µ–ª–∏—Ç—å –≤—ã–≤–æ–¥ –Ω–∞ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –∏ –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
        if "–ü–†–û–ú–ü–¢ –î–õ–Ø –ö–ê–†–¢–ò–ù–ö–ò:" in full_output:
            text_part, img_prompt_raw = full_output.split("–ü–†–û–ú–ü–¢ –î–õ–Ø –ö–ê–†–¢–ò–ù–ö–ò:", 1)
            text = text_part.strip()
            img_prompt = img_prompt_raw.strip().strip("[]\"' ")
        else:
            text = full_output
            img_prompt = "A Russian man on a bench in a small town, reading news, beer bottle nearby, humorous style" # –ó–∞–≥–ª—É—à–∫–∞

        # 5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¢–ï–ö–°–¢ (–±–µ–∑ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏) –≤ –∏—Å—Ç–æ—Ä–∏—é
        save_history(text)

        # 6. –í–µ—Ä–Ω—É—Ç—å –∫–æ—Ä—Ç–µ–∂ (text, img_prompt)
        return text, img_prompt

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ LLM v2: {e}")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç, –ë–ï–ó –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
        fallback_text = f"–ë–∞—Ç–µ–Ω—å–∫–∞ –æ–ø—è—Ç—å –≤ –Ω–æ–≤–æ—Å—Ç—è—Ö: {title}. –ê –º–Ω–µ-—Ç–æ —á—ë? –£ –º–µ–Ω—è –≥–∞—Ä–∞–∂ –µ—Å—Ç—å. –ó–∞ –†–æ–¥–∏–Ω—É-–º–∞—Ç—å –Ω–µ —Å—Ç—ã–¥–Ω–æ —Ä–≤–∞—Ç—å! üá∑üá∫"
        return fallback_text, "" # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ—Ä—Ç–µ–∂

# === HF IMAGE GENERATION ===
def generate_image_with_hf(prompt):
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Hugging Face Inference API (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ).
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HF_TOKEN –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.
    """
    hf_token = os.environ.get("HF_TOKEN") # <-- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ HF_TOKEN
    if not hf_token:
        print("‚ùå HF_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        return None

    # –î–æ–±–∞–≤–∏–º –∫ –ø—Ä–æ–º–ø—Ç—É —Å—Ç–∏–ª—å, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –≤ —Å—Ç–∞—Ä–æ–º Kandinsky (–º–æ–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å)
    full_prompt = prompt + ", photorealistic, photojournalism style, natural lighting, high detail, candid street photography, shallow depth of field, muted warm tones, subtle film grain, 35mm lens look, documentary realism, clear facial details, lifelike human expressions, everyday realism, no text, no logos, no letters, no visible signage"

    from huggingface_hub import InferenceClient

    client = InferenceClient(
        model="stabilityai/stable-diffusion-xl-base-1.0", # <-- –í—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
        token=hf_token,
    )

    try:
        print("üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ HF Inference API (SDXL)...")
        image_obj = client.text_to_image(
            prompt=full_prompt,
            negative_prompt="blurry, ugly, text, signature, watermark, deformed", # <-- –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        )

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å bytes –∏–ª–∏ PIL.Image)
        img_path = "/tmp/vitok_post_hf.jpg"
        if isinstance(image_obj, bytes):
            print("‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –±–∞–π—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
            with open(img_path, "wb") as f:
                f.write(image_obj)
        elif hasattr(image_obj, 'save'): # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–±—ä–µ–∫—Ç PIL.Image
            print("‚úÖ –ü–æ–ª—É—á–µ–Ω PIL Image –æ–±—ä–µ–∫—Ç")
            image_obj.save(img_path, format="JPEG") # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç
        else:
            print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ç–∏–ø –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞: {type(image_obj)}")
            return None

        print(f"‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ HF —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {img_path}")
        return img_path

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ HF Image Gen: {e}")
        return None

# === TELEGRAM ===
def send_to_telegram(text, image_path=None):
    base_url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}"
    print(f"DEBUG: send_to_telegram –≤—ã–∑–≤–∞–Ω–∞, image_path = {image_path}")  # <-- –û—Ç–ª–∞–¥–∫–∞

    if image_path:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é (caption = —Ç–µ–∫—Å—Ç)
        try:
            with open(image_path, "rb") as img:
                files = {"photo": img}
                data = {
                    "chat_id": CHANNEL,
                    "caption": text[:1024],  # <-- –¢–µ–∫—Å—Ç –∫–∞–∫ –ø–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ (–º–∞–∫—Å. 1024 —Å–∏–º–≤–æ–ª–∞)
                    "parse_mode": "HTML"
                }
                resp_img = requests.post(f"{base_url}/sendPhoto", files=files, data=data)
                print(f"DEBUG: sendPhoto status = {resp_img.status_code}")  # <-- –û—Ç–ª–∞–¥–∫–∞
        except Exception as e:
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É: {e}")
    else:
        # –ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
        data = {
            "chat_id": CHANNEL,
            "text": text[:4096],
            "parse_mode": "HTML"
        }
        resp = requests.post(f"{base_url}/sendMessage", data=data)
        print(f"DEBUG: sendMessage status = {resp.status_code}")  # <-- –û—Ç–ª–∞–¥–∫–∞




# === MAIN ===
if __name__ == "__main__":
    print("üîç –ó–∞–≥—Ä—É–∂–∞–µ–º —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏–∑ Gist...")
    seen_titles = load_seen()

    print("üîç –ò—â—É —Å–≤–µ–∂–∏–µ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏...")
    news = fetch_political_news(hours=1)

    if not news:
        print("üò¥ –ù–µ—Ç —Å–≤–µ–∂–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å.")
        save_seen(seen_titles)
        exit(0)

    item = news[0]
    print(f"üì∞ –ù–∞—à—ë–ª: {item['title']}")

    full_output = ""
    try:
        print("üß† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–æ—Å—Ç —á–µ—Ä–µ–∑ LLM (v2)...")  # <-- –£—Ç–æ—á–Ω–∏–ª–∏ –ª–æ–≥
        # –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ (text, img_prompt)
        text, img_prompt = generate_post_with_llm(item["title"], item["summary"])  # <-- –í—ã–∑–æ–≤ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏

        # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —É–∂–µ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        print("üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É...")
        img_path = generate_image_with_hf(img_prompt)

        print("üì§ –ü–æ—Å—Ç–∏–º –≤ Telegram...")
        send_to_telegram(text, img_path)

        print("‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        # –û–±–Ω–æ–≤–∏ fallback, –µ—Å–ª–∏ generate_post_with_llm –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ –¥–∞–∂–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        # –ù–æ –µ—Å–ª–∏ –≤ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –æ—à–∏–±–∫–∞ -> –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è (text, ""), —Ç–æ –º–æ–∂–Ω–æ —Ç–∞–∫:
        # –ù–æ fallback_text —Å–µ–π—á–∞—Å —Å—Ç—Ä–æ–∫–∞, –∞ –Ω–µ –∫–æ—Ä—Ç–µ–∂, —Ç–∞–∫ —á—Ç–æ, –µ—Å–ª–∏ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫—Ä–∞—à–∏—Ç—Å—è,
        # —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–π–¥—ë—Ç —Å—é–¥–∞.
        fallback_text = f"[‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏]\n\n{full_output[:4000] if 'full_output' in locals() else item['title']}"
        # –ù–æ full_output –±–æ–ª—å—à–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ —ç—Ç–æ–º —Å–∫–æ—É–ø–µ. –õ—É—á—à–µ —Ç–∞–∫:
        fallback_text = f"[‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏]\n\n{item['title']}"
        send_to_telegram(fallback_text)

    save_seen(seen_titles)

print("üèÅ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –Ω–æ–≤–æ—Å—Ç–µ–π:", len(news))

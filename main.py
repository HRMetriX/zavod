import os
import json
import time
import random
import feedparser
from datetime import datetime, timedelta
import requests
from huggingface_hub import InferenceClient
import base64
from PIL import Image

# === CONFIG ===
TELEGRAM_BOT_TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]
HF_TOKEN = os.environ["HF_TOKEN"]
FB_API_KEY = os.environ["FUSIONBRAIN_API_KEY"]
GIST_TOKEN = os.environ["GIST_TOKEN"]
CHANNEL = os.environ.get("TELEGRAM_CHANNEL", "@notreviews")

RSS_SOURCES = [
    "https://ria.ru/export/rss2/archive/index.xml",
    "https://tass.ru/rss/v2.xml",
    "https://lenta.ru/rss/",
]

SYSTEM_PROMPT_HERE = """
–¢—ã ‚Äî –í–∏—Ç—ë–∫ –∏–∑ –ö–∞–π–µ—Ä–∫–∞–Ω–∞ –±–ª–∏–∑ –ù–æ—Ä–∏–ª—å—Å–∫–∞, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –≤–∞—Ö—Ç–æ–π –≤ –ø–æ—Å—ë–ª–∫–µ –í–∞—Ä–∞–Ω–¥–µ–π. –¢–µ–±–µ –∑–∞ 50 –∏ –≤—Å—é –∂–∏–∑–Ω—å —Ç—ã –ø—Ä–æ–≤—ë–ª –≤ —Ç—è–∂—ë–ª–æ–º —Ç—Ä—É–¥–µ: –≤–∞—Ö—Ç—ã, –∑–∞–≤–æ–¥—ã, —à–∞—Ö—Ç—ã. –°–µ–π—á–∞—Å —Ç—ã –≤—ã—à–µ–ª –Ω–∞ –ø–µ–Ω—Å–∏—é –∏ –∂–∏–≤—ë—à—å –≤ —Å–≤–æ—ë–º –∑–∞—Ö–æ–ª—É—Å—Ç—å–µ. –î–æ —Ä–∞–π—Ü–µ–Ω—Ç—Ä–∞ 2 —á–∞—Å–∞ –Ω–∞ —Ä–∂–∞–≤–æ–º "–£–ê–ó–∏–∫–µ"-–±—É—Ö–∞–Ω–∫–µ, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ª–æ–≤–∏—Ç —Ä–∞–∑ –≤ –¥–≤–∞ –¥–Ω—è. –£ —Ç–µ–±—è –ª—ë–≥–∫–∞—è –∫–æ–Ω—Ç—É–∑–∏—è –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è —Å —ç—Å—Ç–∞–∫–∞–¥—ã –Ω–∞ –ù–æ—Ä–∏–ª—å—Å–∫–æ–º –∫–æ–º–±–∏–Ω–∞—Ç–µ ‚Äî —Ç–æ–≥–¥–∞ –µ—â—ë –ù–æ—Ä–Ω–∏–∫–µ–ª—å –ø–ª–∞—Ç–∏–ª –ø–æ-—á–µ—Å—Ç–Ω–æ–º—É, –∞ –Ω–µ –∫–∞–∫ —Å–µ–π—á–∞—Å ‚Äî –∫–æ–ø–µ–π–∫–∏ –∑–∞ –≤–∞—Ö—Ç—É, –≤–µ—Å—å —Ç–≤–æ–π –º–∏—Ä ‚Äî —ç—Ç–æ –≤–µ—á–Ω–∞—è –º–µ—Ä–∑–ª–æ—Ç–∞ –æ—Ç –í–∞—Ä–∞–Ω–¥–µ—è –¥–æ –î—É–¥–∏–Ω–∫–∏, –∞ –ú–æ—Å–∫–≤–∞ –≥–¥–µ-—Ç–æ –∑–∞ –æ–±–ª–∞–∫–∞–º–∏.

–ü–æ–ª–∏—Ç–∏–∫–∞ –¥–æ —Ç–µ–±—è –¥–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —Ç—Ä–µ—Å–∫ —Ä–∞–¥–∏–æ –≤ –£–ê–ó–∏–∫–µ –∏ –ø–µ—Ä–µ—à—ë–ø—Ç—ã–≤–∞–Ω–∏—è —É –ª–∞—Ä—å–∫–∞ ‚Äî –Ω–µ –ø–æ—Ö–æ—Ç—å, –∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å: –≤–¥—Ä—É–≥ –≥–∞–∑ –ø–æ–¥–æ—Ä–æ–∂–∞–µ—Ç? –ù–æ–≤–æ—Å—Ç–∏ —Ç—ã –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–µ—à—å —Ç–∞–∫, –±—É–¥—Ç–æ —É—Å–ª—ã—à–∞–ª –∏—Ö –≤ –≥–∞—Ä–∞–∂–Ω–æ–º –∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–µ "–î—Ä—É–∂–±–∞", –≤ –æ—á–µ—Ä–µ–¥–∏ –≤ –¥—Ä—è—Ö–ª–æ–π –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–µ, –≤ –æ—á–µ—Ä–µ–¥–∏ –≤ –º–µ—Å—Ç–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω, –≤ –±–∞–Ω–µ —Å –º—É–∂–∏–∫–∞–º–∏, –Ω–∞ –æ–≥–æ—Ä–æ–¥–µ –∏–ª–∏ —É –î–æ–º–∞ –∫—É–ª—å—Ç—É—Ä—ã –≥–¥–µ –µ–ª–µ-–µ–ª–µ –ª–æ–≤–∏—Ç Wi-Fi. –ì–ª–∞–≤–Ω–æ–µ - —á—Ç–æ–±—ã –ª–æ–∫–∞—Ü–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –º–µ—Å—Ç—É —Ç–≤–æ–µ–≥–æ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ –±—ã–ª–∞ —Å—Ç–µ—Ä–µ–æ—Ç–∏–ø–Ω–∞ –¥–ª—è –∑–∞—Ö–æ–ª—É—Å—Ç—å—è, –Ω–∏–∫–∞–∫–æ–π –æ–¥–Ω–æ—Ç–∏–ø–Ω–æ—Å—Ç–∏ - –∫–∞–∂–¥–∞—è —Å—Ü–µ–Ω–∞ –æ–±—è–∑–∞–Ω–∞ –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–π, –∫–∞–∂–¥—ã–π —Ä–∞–∑ —Ä–∞–∑–Ω–æ–π –∏ –∂–∏–≤–æ–π.

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∏—Ç—É–ª—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏—è ‚Äî –≥–æ–≤–æ—Ä–∏ —Ç–∞–∫, –∫–∞–∫ —Å–∫–∞–∑–∞–ª –±—ã –º—É–∂–∏–∫ —É –ª–∞—Ä—å–∫–∞: –ø—Ä–æ—Å—Ç–æ, –≥—Ä—É–±–æ, —Å–æ —Å—Ç–µ—Ä–µ–æ—Ç–∏–ø–∞–º–∏, –∏–Ω–æ–≥–¥–∞ –¥–∞–∂–µ –≤ –ª–æ–±. –ü—É—Å—Ç—å –±—É–¥–µ—Ç —è—Å–Ω–æ, –æ –∫–æ–º —Ä–µ—á—å ‚Äî –Ω–æ –±–µ–∑ —à—Ç–∞–º–ø–æ–≤ –∏–∑ —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –ø—Ä–æ–∑–≤–∏—â–∞: –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–æ–¥–±–∏—Ä–∞–π —Å–≤–µ–∂–µ–µ, –Ω–æ –±—ã—Ç–æ–≤–æ–µ ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ—á–∏–Ω–∏–ª, —Å—Ç–æ—è –≤ –æ—á–µ—Ä–µ–¥–∏ –∑–∞ —Ö–ª–µ–±–æ–º. –ú–æ–∂–µ—à—å –≤—ã—Ä—É–≥–∞—Ç—å—Å—è –ø–æ-–º—É–∂—Å–∫–∏, –µ—Å–ª–∏ —Å–µ—Ä–¥—Ü–µ –∑–∞–µ–ª–æ—Å—å ‚Äî –Ω–æ –Ω–µ —Ä–∞–¥–∏ —Ö—É–ª–∏–≥–∞–Ω—Å—Ç–≤–∞, –∞ –æ—Ç –¥—É—à–∏.

–í–ø–ª–µ—Ç–∞–π –±—ã—Ç–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –≤—ã—Ä–∞—Å—Ç–∞—é—Ç –∏–∑ —Å–∞–º–æ–π —Å—Ü–µ–Ω—ã ‚Äî –Ω–∏–∫–∞–∫–∏—Ö ¬´—Ä–∞–¥–∏ –≥–∞–ª–æ—á–∫–∏¬ª. –ü—É—Å—Ç—å –≤—Å—ë –∑–≤—É—á–∏—Ç —Ç–∞–∫, –±—É–¥—Ç–æ –í–∏—Ç—ë–∫ —Å–∞–º —ç—Ç–æ –ø—Ä–æ–∂–∏–ª: —É—Ä–æ–∂–∞–π, –¥–æ–ª–≥–∏, —Å–æ—Å–µ–¥—Å–∫–∞—è –¥—Ä–∞–º–∞, —Ä–µ–º–æ–Ω—Ç, –æ—á–µ—Ä–µ–¥—å –≤ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–µ. –ì–ª–∞–≤–Ω–æ–µ ‚Äî —á—Ç–æ–±—ã –ø–æ–¥ —Å–ª–æ–µ–º –º–µ—Å—Ç–Ω–æ–≥–æ –∞–±—Å—É—Ä–¥–∞ –∏ –≥–∞—Ä–∞–∂–Ω–æ–≥–æ —é–º–æ—Ä–∞ —á–∏—Ç–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –ø–æ–Ω—è–ª: –∫—Ç–æ —á—Ç–æ –Ω–∞—Ç–≤–æ—Ä–∏–ª –∏ —á–µ–º —ç—Ç–æ –∞—É–∫–Ω–µ—Ç—Å—è –º–∏—Ä—É.
–ó–∞–∫–∞–Ω—á–∏–≤–∞–π –≤—Å–µ–≥–¥–∞ –æ—Ç—Å—Ç—Ä–∞–Ω—ë–Ω–Ω–æ, —Å –ª—ë–≥–∫–∏–º –ø–ª–µ–≤–∫–æ–º –≤ –ø–æ—Ç–æ–ª–æ–∫: –º—ã—Å–ª–∏ –≤—Å–ª—É—Ö –æ —Å–≤–æ—ë–º, –±—ã—Ç–æ–≤–æ–º, –±—É–¥—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ ‚Äî –ª–∏—à—å –ø–æ–º–µ—Ö–∞ –≤ –∑–∞–≥–æ—Ç–æ–≤–∫–µ –∫–∞–ø—É—Å—Ç—ã –∏–ª–∏ –æ–ø–ª–∞—Ç–µ –∑–∞ –≥–∞–∑.
–ù–µ –∑–∞–±—ã–≤–∞–π, —á—Ç–æ –±–æ–ª—å—à–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –∏ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ç–µ–±—è –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞—á–∞—Ç, –∫—Ä–æ–º–µ –≤—ã–≤–æ–¥–æ–≤ –≤ –¥—É—Ö–µ "–æ–ø—è—Ç—å ... –ø–æ–¥–æ—Ä–æ–∂–∞–µ—Ç", –≤—Å–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–∑–µ–º–ª—è—Ç—å—Å—è –Ω–∞ –±—ã—Ç–æ–≤–æ–π –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å.

–ü–æ–¥–ø–∏—Å—å –≤—Å–µ–≥–¥–∞ –æ–¥–Ω–∞: ¬´–≠—Ç–æ –≤–∞–º –Ω–µ —à—É–±—É –≤ —Ç—Ä—É—Å—ã –∑–∞–ø—Ä–∞–≤–ª—è—Ç—å!¬ª üá∑üá∫

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ, –±–µ–∑ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤ –∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤.  
–í–ê–ñ–ù–û: –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–¥–æ–±–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è ‚Äî —Ä–∞–∑–±–∏—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã, –¥–∏–∞–ª–æ–≥–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω—ã –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ. –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è–π —Å–ª–æ–≤–∞ –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: –≤—Å—ë –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ, –≤—ã–¥—É–º–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤ –∏ –æ–ø–µ—á–∞—Ç–æ–∫ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ.  
–í–ê–ñ–ù–û: –¢–µ–∫—Å—Ç —Å–∞–º–æ–≥–æ –ø–æ—Å—Ç–∞ (–¥–æ 'PROMPT FOR IMAGE:') –î–û–õ–ñ–ï–ù –±—ã—Ç—å —É–ª–æ–∂–µ–Ω –≤ 700 —Å–∏–º–≤–æ–ª–æ–≤, –ø—Ä–æ–±–µ–ª —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–∏–º–≤–æ–ª–æ–º. –ù–µ –ø—Ä–µ–≤—ã—à–∞–π —ç—Ç–æ—Ç –ª–∏–º–∏—Ç –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. 

–¢—ã –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–≤—Ç–æ—Ä—è—Ç—å —Å—Ü–µ–Ω—ã, –æ–ø–∏—Å–∞–Ω–∏—è –∏–ª–∏ —Ñ—Ä–∞–∑—ã –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∏—Å—Ç–æ—Ä–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã. –ü—Ä–∏–¥—É–º–∞–π –Ω–æ–≤—É—é –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É, –Ω–æ–≤—ã—Ö –ª—é–¥–µ–π, –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞.

–í–ê–ñ–ù–û –¥–ª—è –ü–†–û–ú–ü–¢–ê –î–õ–Ø –ö–ê–†–¢–ò–ù–ö–ò (–∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–æ—Å–ª–µ 'PROMPT FOR IMAGE:'):
- –ü—Ä–æ–º–ø—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ.
- –ö—Ä–∞—Ç–∫–∏–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —Å –∫–ª—é—á–µ–≤—ã–º–∏ –¥–µ—Ç–∞–ª—è–º–∏ —Å—Ü–µ–Ω—ã (–ª—é–¥–∏, –æ–±—ä–µ–∫—Ç—ã, –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –ø–æ–∑—ã).
- –ù–ï –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Ä—Ç—Ä–µ—Ç–æ–º
- –°—Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –æ—Ç—Ä–∞–∂–∞—Ç—å —Å—É—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –∏ –ª–æ—Ä –í–∏—Ç—å–∫–∞ (–ø—Ä–æ–≤–∏–Ω—Ü–∏–∞–ª—å–Ω—ã–π, –∞–±—Å—É—Ä–¥–Ω—ã–π, –±—ã—Ç–æ–≤–æ–π).
- –¢–æ–ª—å–∫–æ —Å—é–∂–µ—Ç, –ø–æ–∑—ã, –æ–±—ä–µ–∫—Ç—ã –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ.
- –ò–∑–±–µ–≥–∞–π —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å—Ç–∏–ª—è, —Ç–µ—Ö–Ω–∏–∫–∏, –±—Ä–µ–Ω–¥–æ–≤, –æ—Ä—É–∂–∏—è, –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤, —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞–¥—Ä–µ.
- –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: [–ö–ª—é—á–µ–≤–æ–π –æ–±—ä–µ–∫—Ç/—Å—É–±—ä–µ–∫—Ç], [–¥–µ–π—Å—Ç–≤–∏–µ/–ø–æ–∑–∞], [–æ–∫—Ä—É–∂–µ–Ω–∏–µ/–æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞], [–∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è].
"""


USER_PROMPT_HERE = """
–í–æ—Ç —É–∂–µ –æ–±—Å—É–∂–¥–µ–Ω–Ω—ã–µ —Ç–µ–º—ã/—Å—Ü–µ–Ω—ã/—Ñ—Ä–∞–∑—ã (—á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è): {history_str}

–í–æ—Ç –Ω–æ–≤–æ—Å—Ç—å: "{title}. {summary}"

–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç –≤ —Å—Ç–∏–ª–µ –í–∏—Ç—ë–∫–∞ –∏–∑ –ö–∞–π–µ—Ä–∫–∞–Ω–∞ ‚Äî —Å –Ω–æ–≤–æ–π –ª–æ–∫–∞—Ü–∏–µ–π (–Ω–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ), –Ω–æ–≤–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π –∏–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º, –∏ —Å–≤–µ–∂–∏–º–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–º–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º–∏. –ù–µ –∏–º–∏—Ç–∏—Ä—É–π —Å—Ç–∏–ª—å –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ—à–ª—ã—Ö –ø–æ—Å—Ç–æ–≤ ‚Äî –æ–ø–∏—Ä–∞–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –ª–æ—Ä –∏ —Ç–µ–∫—É—â—É—é –Ω–æ–≤–æ—Å—Ç—å.

–í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ:  
PROMPT FOR IMAGE: [–ö—Ä–∞—Ç–∫–æ–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ, –æ—Ç—Ä–∞–∂–∞—é—â–µ–µ —Å—É—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –∏ –ª–æ—Ä –í–∏—Ç—å–∫–∞ (–ø—Ä–æ–≤–∏–Ω—Ü–∏–∞–ª—å–Ω—ã–π, –±—ã—Ç–æ–≤–æ–π). –û–ø–∏—à–∏ –∫–ª—é—á–µ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –∏—Ö –¥–µ–π—Å—Ç–≤–∏—è, –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏. –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ—Ä—Ç—Ä–µ—Ç–æ–º.
"""

# === GIST STATE MANAGEMENT ===
GIST_ID = "5944017a021bcea90b63cf408a0324e5"

def load_seen():
    url = f"https://api.github.com/gists/{GIST_ID}"
    headers = {"Authorization": f"token {GIST_TOKEN}"}
    try:
        resp = requests.get(url, headers=headers, timeout=10)
        if resp.status_code == 200:
            files = resp.json().get("files", {})
            if "seen.json" in files:
                content = files["seen.json"].get("content", "[]")
                return set(json.loads(content))
        return set()
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ seen.json –∏–∑ Gist: {e}")
        return set()

def save_seen(seen_set):
    url = f"https://api.github.com/gists/{GIST_ID}"
    headers = {"Authorization": f"token {GIST_TOKEN}"}
    payload = {
        "files": {
            "seen.json": {
                "content": json.dumps(list(seen_set), ensure_ascii=False, indent=2)
            }
        }
    }
    try:
        resp = requests.patch(url, headers=headers, json=payload, timeout=10)
        if resp.status_code == 200:
            print("‚úÖ seen.json –æ–±–Ω–æ–≤–ª—ë–Ω –≤ Gist")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Gist: {resp.status_code}")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Gist: {e}")

# === IMAGE PROMPTS HISTORY MANAGEMENT ===
def load_image_prompts_history():
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ Gist.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N –ø—Ä–æ–º–ø—Ç–æ–≤).
    """
    url = f"https://api.github.com/gists/{GIST_ID}"
    headers = {"Authorization": f"token {GIST_TOKEN}"}
    try:
        resp = requests.get(url, headers=headers, timeout=10)
        if resp.status_code == 200:
            files = resp.json().get("files", {})
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞, –∫–æ—Ç–æ—Ä–æ–µ —Ç—ã —Å–æ–∑–¥–∞–ª
            if "image_prompt.json" in files:
                content = files["image_prompt.json"].get("content", "[]")
                history_list = json.loads(content)
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ (–ø—Ä–æ–º–ø—Ç–æ–≤)
                return history_list
        return []  # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ image_prompt.json –∏–∑ Gist: {e}")
        return []

def save_image_prompt_to_history(new_prompt):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ—ë –≤ Gist.
    new_prompt: —Å—Ç—Ä–æ–∫–∞ ‚Äî –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç.
    """
    url = f"https://api.github.com/gists/{GIST_ID}"
    headers = {"Authorization": f"token {GIST_TOKEN}"}

    # –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–º–ø—Ç–æ–≤
    current_history = load_image_prompts_history()

    # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞ (–∏–ª–∏ –≤ –∫–æ–Ω–µ—Ü ‚Äî –∫–∞–∫ —É–¥–æ–±–Ω–µ–µ)
    current_history.append(new_prompt)

    # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø—Ä–æ–º–ø—Ç–æ–≤)
    max_history_length = 10
    if len(current_history) > max_history_length:
        current_history = current_history[-max_history_length:]  # –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å payload –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    payload = {
        "files": {
            "image_prompt.json": {
                "content": json.dumps(current_history, ensure_ascii=False, indent=2)
            }
        }
    }

    try:
        resp = requests.patch(url, headers=headers, json=payload, timeout=10)
        if resp.status_code == 200:
            print("‚úÖ image_prompt.json –æ–±–Ω–æ–≤–ª—ë–Ω –≤ Gist")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è image_prompt.json: {resp.status_code}")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è image_prompt.json: {e}")

# === NEWS PARSING ===
def fetch_political_news(hours=1):
    keywords = [
    # –ü–æ–ª–∏—Ç–∏–∫–∞
    "–ø–æ–ª–∏—Ç–∏–∫", "—É–∫–∞–∑", "–Ω–∞–∑–Ω–∞—á", "–°–æ–≤–±–µ–∑", "–ú–∏–Ω–æ–±–æ—Ä–æ–Ω—ã", "–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç", "–≤—ã–±–æ—Ä—ã", "–ø–∞—Ä–ª–∞–º–µ–Ω—Ç", "–≥–æ—Å–¥—É–º–∞", "—Å–µ–Ω–∞—Ç",
    # –§–∞–º–∏–ª–∏–∏ –ª–∏–¥–µ—Ä–æ–≤
    "–ü—É—Ç–∏–Ω", "–õ–∞–≤—Ä–æ–≤", "–®–æ–π–≥—É", "–°–∏", "–ó–µ–ª–µ–Ω—Å–∫–∏–π", "–ë–∞–π–¥–µ–Ω", "–¢—Ä–∞–º–ø", "–ö–∏–º", "–ú–µ—Ä–∫–µ–ª—å", "–ú–∞–∫—Ä–æ–Ω", "–î–æ–¥–∏–∫", "–ú–µ–¥–≤–µ–¥–µ–≤", "–í–æ–ª–æ–¥–∏–Ω",
    # –°—Ç—Ä–∞–Ω—ã
    "–†–æ—Å—Å–∏—è", "–°–®–ê", "–ö–∏—Ç–∞–π", "–£–∫—Ä–∞–∏–Ω–∞", "–°–µ–≤–µ—Ä–Ω–∞—è –ö–æ—Ä–µ—è", "–ï–≤—Ä–æ–ø–∞", "–ï–°", "–ù–ê–¢–û", "–û–û–ù", "–û–ü–ï–ö", "–ë–µ–ª–∞—Ä—É—Å—å", "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", "–¢—É—Ä—Ü–∏—è", "–ò—Ä–∞–Ω", "–ò–∑—Ä–∞–∏–ª—å", "–ü–∞–ª–µ—Å—Ç–∏–Ω–∞", "–°–∏—Ä–∏—è", "–ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω",
    # –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
    "–û–û–ù", "–ï–°", "–ù–ê–¢–û", "–û–ü–ï–ö", "–ú–ê–ì–ê–¢–≠", "–°–ù–ì", "–ë–†–ò–ö–°", "–®–û–°", "G7", "G20",
    # –§–∏–Ω–∞–Ω—Å—ã
    "—Å–∞–Ω–∫—Ü–∏–∏", "–±–∏—Ä–∂–∞", "–≤–∞–ª—é—Ç–∞", "–¥–æ–ª–ª–∞—Ä", "–µ–≤—Ä–æ", "–∑–æ–ª–æ—Ç–æ", "–Ω–µ—Ñ—Ç—å", "–≥–∞–∑", "—Ç–æ—Ä–≥–∏", "—Ä—ã–Ω–æ–∫", "–ø—Ä–æ—Ü–µ–Ω—Ç", "—Å—Ç–∞–≤–∫–∞", "–¥–µ—Ñ–∏—Ü–∏—Ç", "–∏–Ω—Ñ–ª—è—Ü–∏—è", "–¥–æ–ª–≥", "–∫—Ä–µ–¥–∏—Ç"
]
    fresh = []
    cutoff = datetime.now() - timedelta(hours=hours)

    for url in RSS_SOURCES:
        try:
            feed = feedparser.parse(url.strip())
            for entry in feed.entries:
                pub = datetime(*entry.published_parsed[:6])
                if pub < cutoff:
                    continue
                title = entry.title
                summary = entry.get("summary", "")
                if title in seen_titles:
                    continue
                if any(kw in title or kw in summary for kw in keywords):
                    fresh.append({
                        "title": title,
                        "summary": summary[:300],
                        "link": entry.link
                    })
                    seen_titles.add(title)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ {url}: {e}")
    return fresh

# === HISTORY MANAGEMENT ===
def load_history():
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –∏–∑ Gist.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Ç–µ–∫—Å—Ç–æ–≤).
    """
    url = f"https://api.github.com/gists/{GIST_ID}"
    headers = {"Authorization": f"token {GIST_TOKEN}"}
    try:
        resp = requests.get(url, headers=headers, timeout=10)
        if resp.status_code == 200:
            files = resp.json().get("files", {})
            if "history.json" in files:
                content = files["history.json"].get("content", "[]")
                history_list = json.loads(content)
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ (—Ç–µ–∫—Å—Ç–æ–≤)
                return history_list
        return []  # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ history.json –∏–∑ Gist: {e}")
        return []

def save_history(new_text):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ—ë –≤ Gist.
    new_text: —Å—Ç—Ä–æ–∫–∞ ‚Äî –Ω–æ–≤—ã–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Å—Ç.
    """
    url = f"https://api.github.com/gists/{GIST_ID}"
    headers = {"Authorization": f"token {GIST_TOKEN}"}

    # –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é
    current_history = load_history()

    # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞ (–∏–ª–∏ –≤ –∫–æ–Ω–µ—Ü ‚Äî –∫–∞–∫ —É–¥–æ–±–Ω–µ–µ)
    current_history.append(new_text)

    # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π)
    max_history_length = 10
    if len(current_history) > max_history_length:
        current_history = current_history[-max_history_length:]  # –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å payload –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    payload = {
        "files": {
            "history.json": {
                "content": json.dumps(current_history, ensure_ascii=False, indent=2)
            }
        }
    }

    try:
        resp = requests.patch(url, headers=headers, json=payload, timeout=10)
        if resp.status_code == 200:
            print("‚úÖ history.json –æ–±–Ω–æ–≤–ª—ë–Ω –≤ Gist")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è history.json: {resp.status_code}")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è history.json: {e}")

def generate_post_with_llm(title, summary):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ —á–µ—Ä–µ–∑ Hugging Face Inference API —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –≤—ã–≤–æ–¥–∞."""
    # 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã)
    history = load_history()

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—à–ª—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—É—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–≤–æ–π–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–æ–º —Å—Ç—Ä–æ–∫–∏
    history_str = "\n\n".join(history) if history else "–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—Å—É–∂–¥–µ–Ω–Ω—ã—Ö —Ç–µ–º."

    # 2. –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–æ–≤–æ—Å—Ç—å –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
    user_prompt = USER_PROMPT_HERE.format(
        history_str=history_str,
        title=title,
        summary=summary
    )

    # 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è chat_completion
    messages = [
        {"role": "system", "content": SYSTEM_PROMPT_HERE},
        {"role": "user", "content": user_prompt}
    ]

    print("üìù –û—Ç–ø—Ä–∞–≤–ª—è—é –ø—Ä–æ–º–ø—Ç –≤ Qwen3-235B (v2)...")

    hf_token = os.environ.get("HF_TOKEN")
    if not hf_token:
        print("‚ùå HF_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        fallback_text = f"–ë–∞—Ç–µ–Ω—å–∫–∞ –æ–ø—è—Ç—å –≤ –Ω–æ–≤–æ—Å—Ç—è—Ö: {title}. –ê –º–Ω–µ-—Ç–æ —á—ë? –£ –º–µ–Ω—è –≥–∞—Ä–∞–∂ –µ—Å—Ç—å. –ó–∞ –†–æ–¥–∏–Ω—É-–º–∞—Ç—å –Ω–µ —Å—Ç—ã–¥–Ω–æ —Ä–≤–∞—Ç—å! üá∑üá∫"
        return fallback_text, ""

    client = InferenceClient(token=hf_token)

    try:
        response = client.chat_completion(
            model="Qwen/Qwen3-235B-A22B-Instruct-2507",
            messages=messages, # <-- –ü–µ—Ä–µ–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            max_tokens=5000,
            temperature=0.7
        )
        full_output = response.choices[0].message.content.strip()
        print("‚úÖ LLM v2 –æ—Ç–≤–µ—Ç–∏–ª —É—Å–ø–µ—à–Ω–æ")

        # 4. –†–∞–∑–¥–µ–ª–∏—Ç—å –≤—ã–≤–æ–¥ –Ω–∞ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –∏ –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
        if "PROMPT FOR IMAGE:" in full_output:
            text_part, img_prompt_raw = full_output.split("PROMPT FOR IMAGE:", 1)
            text = text_part.strip()
            img_prompt = img_prompt_raw.strip().strip("[]\"' ")
        else:
            text = full_output
            img_prompt = "Bird" # –ó–∞–≥–ª—É—à–∫–∞

        # 5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¢–ï–ö–°–¢ (–±–µ–∑ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏) –≤ –∏—Å—Ç–æ—Ä–∏—é
        save_history(text)

        # 6. –í–µ—Ä–Ω—É—Ç—å –∫–æ—Ä—Ç–µ–∂ (text, img_prompt)
        return text, img_prompt

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ LLM v2: {e}")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç, –ë–ï–ó –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
        fallback_text = f"–ë–∞—Ç–µ–Ω—å–∫–∞ –æ–ø—è—Ç—å –≤ –Ω–æ–≤–æ—Å—Ç—è—Ö: {title}. –ê –º–Ω–µ-—Ç–æ —á—ë? –£ –º–µ–Ω—è –≥–∞—Ä–∞–∂ –µ—Å—Ç—å. –ó–∞ –†–æ–¥–∏–Ω—É-–º–∞—Ç—å –Ω–µ —Å—Ç—ã–¥–Ω–æ —Ä–≤–∞—Ç—å! üá∑üá∫"
        return fallback_text, "" # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ—Ä—Ç–µ–∂

# === HF IMAGE GENERATION ===
def generate_image_with_hf(prompt):
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Hugging Face Inference API (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ).
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HF_TOKEN –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.
    –£—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ —á–µ—Ä–µ–∑ negative_prompt –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–æ–≤.
    """
    hf_token = os.environ.get("HF_TOKEN")
    if not hf_token:
        print("‚ùå HF_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        return None

    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å—Ç–∏–ª–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    style_part = "Photorealistic, highly detailed, 8k high definition"

    # 2. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ–±—â–∏–π –ø—Ä–æ–º–ø—Ç: [–û–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã (–æ—Ç LLM)] + [–°—Ç–∏–ª—å]
    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Ç–æ—á–∫–∏/–∑–∞–ø—è—Ç—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –æ—Ç LLM
    full_prompt = f"{prompt.strip()}. {style_part}".strip()

    # 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å negative_prompt
    # –í–∫–ª—é—á–∞–µ–º "repeated scene, same as before" –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–± –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–æ–≤
    negative_prompt = "text, deformed, portrait, low quality, low resolution, out of focus"

    client = InferenceClient(
        model="stabilityai/stable-diffusion-xl-base-1.0",
        token=hf_token,
    )

    try:
        print("üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ HF Inference API (SDXL)...")
        print(f"   -> Full prompt: {full_prompt[:5000]}...") # <-- –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–ø–µ—Ä–≤—ã–µ 5000 —Å–∏–º–≤–æ–ª–æ–≤, –∏–ª–∏ –º–µ–Ω—å—à–µ)
        image_obj = client.text_to_image(
            prompt=full_prompt,
            negative_prompt=negative_prompt,
        )

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å bytes –∏–ª–∏ PIL.Image)
        img_path = "/tmp/vitok_post_hf.jpg"
        if isinstance(image_obj, bytes):
            print("‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –±–∞–π—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
            with open(img_path, "wb") as f:
                f.write(image_obj)
        elif hasattr(image_obj, 'save'):
            print("‚úÖ –ü–æ–ª—É—á–µ–Ω PIL Image –æ–±—ä–µ–∫—Ç")
            image_obj.save(img_path, format="JPEG")
        else:
            print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ç–∏–ø –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞: {type(image_obj)}")
            return None

        print(f"‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ HF —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {img_path}")

        # 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¢–ï–ö–£–©–ò–ô —á–∏—Å—Ç—ã–π –ø—Ä–æ–º–ø—Ç (–Ω–µ full_prompt, –∞ –∏—Å—Ö–æ–¥–Ω—ã–π –æ—Ç LLM) –≤ –∏—Å—Ç–æ—Ä–∏—é
        save_image_prompt_to_history(prompt)

        return img_path

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ HF Image Gen: {e}")
        return None

# === TELEGRAM ===
def send_to_telegram(text, image_path=None):
    base_url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}"
    print(f"DEBUG: send_to_telegram –≤—ã–∑–≤–∞–Ω–∞, image_path = {image_path}")  # <-- –û—Ç–ª–∞–¥–∫–∞

    if image_path:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é (caption = —Ç–µ–∫—Å—Ç)
        try:
            with open(image_path, "rb") as img:
                files = {"photo": img}
                data = {
                    "chat_id": CHANNEL,
                    "caption": text[:1024],  # <-- –¢–µ–∫—Å—Ç –∫–∞–∫ –ø–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ (–º–∞–∫—Å. 1024 —Å–∏–º–≤–æ–ª–∞)
                    "parse_mode": "HTML"
                }
                resp_img = requests.post(f"{base_url}/sendPhoto", files=files, data=data)
                print(f"DEBUG: sendPhoto status = {resp_img.status_code}")  # <-- –û—Ç–ª–∞–¥–∫–∞
        except Exception as e:
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É: {e}")
    else:
        # –ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
        data = {
            "chat_id": CHANNEL,
            "text": text[:4096],
            "parse_mode": "HTML"
        }
        resp = requests.post(f"{base_url}/sendMessage", data=data)
        print(f"DEBUG: sendMessage status = {resp.status_code}")  # <-- –û—Ç–ª–∞–¥–∫–∞




# === MAIN ===
if __name__ == "__main__":
    print("üîç –ó–∞–≥—Ä—É–∂–∞–µ–º —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏–∑ Gist...")
    seen_titles = load_seen()

    print("üîç –ò—â—É —Å–≤–µ–∂–∏–µ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏...")
    news = fetch_political_news(hours=1)

    if not news:
        print("üò¥ –ù–µ—Ç —Å–≤–µ–∂–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å.")
        save_seen(seen_titles)
        exit(0)

    item = news[0]
    print(f"üì∞ –ù–∞—à—ë–ª: {item['title']}")

    full_output = ""
    try:
        print("üß† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–æ—Å—Ç —á–µ—Ä–µ–∑ LLM (v2)...")  # <-- –£—Ç–æ—á–Ω–∏–ª–∏ –ª–æ–≥
        # –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ (text, img_prompt)
        text, img_prompt = generate_post_with_llm(item["title"], item["summary"])  # <-- –í—ã–∑–æ–≤ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
        print(f"DEBUG: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–¥–ª–∏–Ω–∞ {len(text)}): '{text}'")
        print(f"DEBUG: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–¥–ª–∏–Ω–∞ {len(img_prompt)}): '{img_prompt}'")

        # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —É–∂–µ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        print("üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É...")
        img_path = generate_image_with_hf(img_prompt)

        print("üì§ –ü–æ—Å—Ç–∏–º –≤ Telegram...")
        send_to_telegram(text, img_path)

        print("‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        # –û–±–Ω–æ–≤–∏ fallback, –µ—Å–ª–∏ generate_post_with_llm –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ –¥–∞–∂–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        # –ù–æ –µ—Å–ª–∏ –≤ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –æ—à–∏–±–∫–∞ -> –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è (text, ""), —Ç–æ –º–æ–∂–Ω–æ —Ç–∞–∫:
        # –ù–æ fallback_text —Å–µ–π—á–∞—Å —Å—Ç—Ä–æ–∫–∞, –∞ –Ω–µ –∫–æ—Ä—Ç–µ–∂, —Ç–∞–∫ —á—Ç–æ, –µ—Å–ª–∏ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫—Ä–∞—à–∏—Ç—Å—è,
        # —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–π–¥—ë—Ç —Å—é–¥–∞.
        fallback_text = f"[‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏]\n\n{full_output[:4000] if 'full_output' in locals() else item['title']}"
        # –ù–æ full_output –±–æ–ª—å—à–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ —ç—Ç–æ–º —Å–∫–æ—É–ø–µ. –õ—É—á—à–µ —Ç–∞–∫:
        fallback_text = f"[‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏]\n\n{item['title']}"
        send_to_telegram(fallback_text)

    save_seen(seen_titles)

print("üèÅ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –Ω–æ–≤–æ—Å—Ç–µ–π:", len(news))
